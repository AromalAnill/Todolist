{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Calendar - Task Calendar{% endblock %}

{% block extra_css %}
<style>
    .calendar-container {
        padding: 2rem;
    }
    
    .calendar {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .calendar-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .calendar-header h2 {
        margin: 0;
        font-size: 1.8rem;
    }
    
    .nav-button {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.3s;
        text-decoration: none;
    }
    
    .nav-button:hover {
        background: rgba(255,255,255,0.3);
        color: white;
    }
    
    .weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background: #e9ecef;
        padding: 1px;
    }
    
    .weekday {
        background: #f8f9fa;
        padding: 1rem;
        text-align: center;
        font-weight: bold;
        color: #667eea;
    }
    
    .days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background: #e9ecef;
        padding: 1px;
        min-height: 25rem;
    }
    
    .day {
        background: white;
        padding: 0.75rem;
        min-height: 5rem;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
        overflow-y: auto;
        max-height: 7rem;
    }
    
    .day:hover {
        background: #f0f4ff;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .day.past {
        background: #f8f9fa;
        color: #999;
        cursor: not-allowed;
    }
    
    .day.today {
        background: #e7f3ff;
        border: 2px solid #667eea;
        font-weight: bold;
    }
    
    .day-number {
        font-weight: bold;
        color: #333;
        margin-bottom: 0.5rem;
        display: block;
        font-size: 0.9rem;
    }
    
    .day.past .day-number {
        color: #999;
    }
    
    .tasks-list {
        font-size: 0.75rem;
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .task-item {
        background: #667eea;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 3px;
        margin-bottom: 0.25rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
    }
    
    .task-item.completed {
        text-decoration: line-through;
        opacity: 0.6;
    }
    
    .empty-slot {
        display: none;
    }
    
    /* Modal Styles */
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-bottom: none;
    }
    
    .modal-header .btn-close {
        filter: brightness(0) invert(1);
    }
    
    .form-control {
        border-radius: 5px;
        border: 1px solid #ddd;
    }
    
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 5px;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #5568d3 0%, #6a3a8f 100%);
    }
    
    /* Toast Notification */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }
    
    .toast {
        background: white;
        padding: 1rem 1.5rem;
        margin-bottom: 0.5rem;
        border-radius: 5px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .toast.success {
        border-left: 4px solid #28a745;
    }
    
    .toast.error {
        border-left: 4px solid #dc3545;
    }
    
    .toast.success::before {
        content: '✓';
        color: #28a745;
        font-weight: bold;
        font-size: 1.2rem;
    }
    
    .toast.error::before {
        content: '✕';
        color: #dc3545;
        font-weight: bold;
        font-size: 1.2rem;
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .calendar-header {
            flex-direction: column;
            gap: 1rem;
        }
        
        .calendar-header h2 {
            font-size: 1.3rem;
        }
        
        .day {
            min-height: 4rem;
        }
        
        .task-item {
            font-size: 0.65rem;
            padding: 0.2rem 0.4rem;
        }
        
        .weekday {
            padding: 0.5rem;
            font-size: 0.85rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="calendar-container">
    <div class="calendar">
        <div class="calendar-header">
            <a href="?year={{ prev_month.year }}&month={{ prev_month.month }}" class="nav-button">← Previous</a>
            <h2>{{ month_year }}</h2>
            <a href="?year={{ next_month.year }}&month={{ next_month.month }}" class="nav-button">Next →</a>
        </div>
        
        <div class="weekdays">
            <div class="weekday">Sun</div>
            <div class="weekday">Mon</div>
            <div class="weekday">Tue</div>
            <div class="weekday">Wed</div>
            <div class="weekday">Thu</div>
            <div class="weekday">Fri</div>
            <div class="weekday">Sat</div>
        </div>
        
        <div class="days">
            {% for week in calendar %}
                {% for day in week %}
                    {% if day == 0 %}
                        <div class="day empty-slot"></div>
                    {% else %}
                        <div class="day" 
                             data-date="{{ current_date.year }}-{{ current_date.month|stringformat:'02d' }}-{{ day|stringformat:'02d' }}"
                             onclick="handleDayClick(this)">
                            <span class="day-number">{{ day }}</span>
                            <ul class="tasks-list">
                                {% if day in task_dict %}
                                    {% for task in task_dict|get_item:day %}
                                        <li class="task-item {% if task.is_completed %}completed{% endif %}" 
                                            data-task-id="{{ task.id }}"
                                            onclick="event.stopPropagation(); toggleTask({{ task.id }})">
                                            {{ task.title|truncatewords:3 }}
                                        </li>
                                    {% endfor %}
                                {% endif %}
                            </ul>
                        </div>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </div>
    </div>
</div>

<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Task for <span id="modalDate"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="taskForm" onsubmit="submitTask(event)">
                <div class="modal-body">
                    <input type="hidden" id="taskDate" name="date">
                    
                    <div class="mb-3">
                        <label for="taskTitle" class="form-label">Task Title *</label>
                        <input type="text" class="form-control" id="taskTitle" name="title" required 
                               placeholder="Enter task title">
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="taskDescription" name="description" rows="3" 
                                  placeholder="Enter task description (optional)"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Task</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Toast Notification Container -->
<div class="toast-container" id="toastContainer"></div>

{% endblock %}

{% block extra_js %}
{% load static %}
<script src="{% static 'js/calendar.js' %}"></script>

<script>
// Django CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Initialize modal
let addTaskModal;
document.addEventListener('DOMContentLoaded', function() {
    addTaskModal = new bootstrap.Modal(document.getElementById('addTaskModal'));
    markPastDatesAndToday();
});

// Mark past dates and today's date
function markPastDatesAndToday() {
    const today = new Date('{{ today }}');
    const dayElements = document.querySelectorAll('.day:not(.empty-slot)');
    
    dayElements.forEach(dayElement => {
        const dateStr = dayElement.getAttribute('data-date');
        const dateObj = new Date(dateStr);
        
        if (dateObj < today) {
            dayElement.classList.add('past');
        } else if (dateObj.toDateString() === today.toDateString()) {
            dayElement.classList.add('today');
        }
    });
}

// Handle day click
function handleDayClick(dayElement) {
    const dateStr = dayElement.getAttribute('data-date');
    if (!dayElement.classList.contains('past')) {
        openAddTaskModal(dateStr);
    } else {
        showToast('Cannot add tasks to past dates', 'error');
    }
}

// Open Add Task Modal
function openAddTaskModal(dateStr) {
    const date = new Date(dateStr + 'T00:00:00');
    
    document.getElementById('taskDate').value = dateStr;
    document.getElementById('modalDate').textContent = date.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDescription').value = '';
    addTaskModal.show();
}

// Submit Task Form
function submitTask(e) {
    e.preventDefault();
    
    const dateStr = document.getElementById('taskDate').value;
    const title = document.getElementById('taskTitle').value.trim();
    const description = document.getElementById('taskDescription').value.trim();
    
    if (!title) {
        showToast('Task title is required', 'error');
        return;
    }
    
    const taskData = {
        title: title,
        description: description,
        due_date: dateStr
    };
    
    fetch('{% url "add_task" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Task added successfully!', 'success');
            addTaskModal.hide();
            // Reload the page to show the new task
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast(data.error || 'Failed to add task', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred while adding the task', 'error');
    });
}

// Toggle Task Completion
function toggleTask(taskId) {
    fetch(`/api/tasks/${taskId}/toggle/`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
            if (data.is_completed) {
                taskElement.classList.add('completed');
            } else {
                taskElement.classList.remove('completed');
            }
            showToast(data.message, 'success');
        } else {
            showToast(data.error || 'Failed to update task', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('An error occurred', 'error');
    });
}

// Show Toast Notification
function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s ease-out';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>

<!-- Django Template Filter for Dictionary Access -->
<script>
// This allows us to access dictionary values in templates
fetch('/api/tasks/get/', { method: 'GET' })
    .catch(() => {}); // Just to load CSRF token
</script>
{% endblock %}
